<!DOCTYPE html>
<!--
    ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ß‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô HTML5
-->
<html lang="th">
<!--
    lang="th" ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á SEO ‡πÅ‡∏•‡∏∞ Accessibility
-->

<head>
    <!-- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î encoding ‡πÄ‡∏õ‡πá‡∏ô UTF-8 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ -->
    <meta charset="UTF-8">

    <!-- ‡∏ó‡∏≥‡πÉ‡∏´‡πâ responsive ‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ó‡πá‡∏ö Browser -->
    <title>DGA Login Redirect</title>

    <!-- =========================
         CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
         ========================= -->
    <style>
        body {
            font-family: sans-serif;     /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
            text-align: center;          /* ‡∏à‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            padding: 50px;               /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤ */
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î */
        .loading {
            font-size: 20px;
            color: #666;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö error */
        .error {
            color: red;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö success */
        .success {
            color: green;
        }
    </style>
</head>

<body>

    <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
    <h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ê...</h1>

    <!--
        ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
        ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î"
    -->
    <p id="message" class="loading">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>

    <script>
        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:
         * 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ mToken ‡πÅ‡∏•‡∏∞ appId ‡∏à‡∏≤‡∏Å URL
         * 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà API ‡∏ù‡∏±‡πà‡∏á Server (C++)
         * 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
         * 4. Redirect ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
         */
        async function autoLogin() {

            // ===============================
            // 1) ‡∏≠‡πà‡∏≤‡∏ô Query String ‡∏à‡∏≤‡∏Å URL
            // ===============================

            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á URL:
            // https://domain.com/callback?mToken=xxx&appId=yyy

            // URLSearchParams ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ parameter ‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
            const urlParams = new URLSearchParams(window.location.search);

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ mToken ‡∏à‡∏≤‡∏Å URL
            const mToken = urlParams.get('mToken');

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ appId ‡∏à‡∏≤‡∏Å URL
            const appId = urlParams.get('appId');

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ mToken ‡∏´‡∏£‡∏∑‡∏≠ appId ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á error ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (!mToken || !appId) {
                document.getElementById('message').innerText =
                    "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö mToken ‡∏´‡∏£‡∏∑‡∏≠ appId";

                document.getElementById('message').className = "error";
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
            }

            try {
                // ===============================
                // 2) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server C++
                // ===============================

                /**
                 * ‡πÉ‡∏ä‡πâ fetch() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á HTTP POST
                 * ‡πÑ‡∏õ‡∏ó‡∏µ‡πà endpoint:
                 *     ./api/auth/login
                 *
                 * ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ ./ ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏ì‡∏µ:
                 * - https://domain.com/api/...
                 * - https://domain.com/test1/api/...
                 */

                const response = await fetch('./api/auth/login', {
                    method: 'POST',                         // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö POST
                    headers: {
                        'Content-Type': 'application/json' // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON
                    },
                    body: JSON.stringify({
                        mToken: mToken,     // token ‡∏à‡∏≤‡∏Å DGA
                        appId: appId        // appId ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
                    })
                });

                // ‡πÅ‡∏õ‡∏•‡∏á response ‡∏à‡∏≤‡∏Å server ‡πÄ‡∏õ‡πá‡∏ô JSON object
                const data = await response.json();

                // ===============================
                // 3) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å Server
                // ===============================

                if (data.status === 'success') {

                    // -------------------------------
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
                    // -------------------------------
                    if (data.type === 'REGISTER_NEEDED') {

                        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏≤‡∏ö
                        document.getElementById('message').innerText =
                            "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...";

                        document.getElementById('message').className = "success";

                        /**
                         * ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å DGA
                         * ‡∏•‡∏á sessionStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ register
                         *
                         * sessionStorage:
                         * - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö
                         * - ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ query string
                         */
                        sessionStorage.setItem(
                            'dga_user',
                            JSON.stringify(data.prefill_data)
                        );

                        // ‡∏£‡∏≠ 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ register
                        setTimeout(() => {
                            window.location.href = './register';
                        }, 1500);

                    } else {

                        // -------------------------------
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ User ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
                        // -------------------------------

                        document.getElementById('message').innerText =
                            `üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${data.user.firstname} ${data.user.lastname}`;

                        document.getElementById('message').className = "success";

                        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡πÉ‡∏ô console (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug)
                        console.log("User Data:", data.user);
                    }

                } else {
                    // -------------------------------
                    // Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏ï‡πà status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà success
                    // -------------------------------

                    // ‡πÇ‡∏¢‡∏ô error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ catch()
                    throw new Error(data.message || 'Login Failed');
                }

            } catch (error) {

                // ===============================
                // 4) ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Å‡∏¥‡∏î error (network, server, json, ‡∏Ø‡∏•‡∏Ø)
                // ===============================

                document.getElementById('message').innerText =
                    "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;

                document.getElementById('message').className = "error";
            }
        }

        // ===============================
        // 5) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        // ===============================
        autoLogin();
    </script>

</body>
</html>
